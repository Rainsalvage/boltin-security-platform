<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missing Device Demo - BOLTIN Security Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .demo-card { 
            border: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-radius: 15px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .demo-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.15); 
        }
        .status-badge { 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-weight: 600; 
            font-size: 0.9em;
        }
        .btn-demo { 
            border-radius: 25px; 
            padding: 10px 25px; 
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .result-card {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .scenario-step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        .finder-form {
            background: #e8f5e8;
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-light">
    <div class="gradient-bg text-white py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-search me-3"></i>Missing Device Demo
                    </h1>
                    <p class="lead mb-4">
                        Test the missing device functionality - Report missing items and simulate found device reports with pickup locations.
                    </p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-mobile-alt fa-6x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <!-- Demo Scenarios -->
        <div class="row">
            <div class="col-md-6">
                <div class="demo-card card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-primary">
                            <i class="fas fa-exclamation-triangle me-2"></i>Scenario 1: Report Missing Device
                        </h5>
                        <p class="card-text">
                            Report a device as missing (not stolen, just misplaced) - like dropping your phone at a seminar.
                        </p>
                        
                        <div class="scenario-step">
                            <strong>Step 1:</strong> Device owner reports item as missing
                        </div>
                        
                        <button class="btn btn-warning btn-demo w-100" onclick="reportMissingDevice()">
                            <i class="fas fa-file-medical-alt me-2"></i>Report Missing Device
                        </button>
                        
                        <div id="missingResult" class="result-card bg-warning bg-opacity-10 border-warning"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="demo-card card h-100">
                    <div class="card-body">
                        <h5 class="card-title text-success">
                            <i class="fas fa-hand-holding me-2"></i>Scenario 2: Found Device Report
                        </h5>
                        <p class="card-text">
                            Someone finds a device and reports it with a pickup location at the admin office.
                        </p>
                        
                        <div class="scenario-step">
                            <strong>Step 2:</strong> Finder reports found device with pickup location
                        </div>
                        
                        <button class="btn btn-success btn-demo w-100" onclick="reportFoundDevice()">
                            <i class="fas fa-search-location me-2"></i>Report Found Device
                        </button>
                        
                        <div id="foundResult" class="result-card bg-success bg-opacity-10 border-success"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Found Device Form -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="finder-form" id="finderForm" style="display: none;">
                    <h4 class="text-success mb-4">
                        <i class="fas fa-hands-helping me-2"></i>Found Device Report Form
                    </h4>
                    <p class="text-muted">Help reunite lost devices with their owners!</p>
                    
                    <form id="foundDeviceForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Your Name *</label>
                                    <input type="text" class="form-control" name="finderName" value="Sarah Johnson" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Your Contact *</label>
                                    <input type="text" class="form-control" name="finderContact" value="sarah.johnson@email.com" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Device Serial Number *</label>
                                    <input type="text" class="form-control" name="serialNumber" value="IP14MISSING2025" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Where did you find it? *</label>
                                    <input type="text" class="form-control" name="foundLocation" value="Conference Room B, TechCorp Building" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Pickup Location *</label>
                                    <input type="text" class="form-control" name="pickupLocation" value="Security Office, TechCorp Building, 9AM-5PM weekdays" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Found Date *</label>
                                    <input type="date" class="form-control" name="foundDate" required>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label">Device Description *</label>
                                    <textarea class="form-control" name="deviceDescription" rows="3" required>Black iPhone with blue case, screen protector, small scratch on back near camera</textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Additional Notes</label>
                                    <textarea class="form-control" name="additionalNotes" rows="2">Found under conference table after morning seminar. Battery was dead when found.</textarea>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success btn-demo">
                            <i class="fas fa-paper-plane me-2"></i>Submit Found Device Report
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pickup Confirmation -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="demo-card card">
                    <div class="card-body">
                        <h5 class="card-title text-info">
                            <i class="fas fa-handshake me-2"></i>Scenario 3: Confirm Pickup
                        </h5>
                        <p class="card-text">
                            Admin confirms that the owner has picked up their device from the designated location.
                        </p>
                        
                        <div class="scenario-step">
                            <strong>Step 3:</strong> Admin confirms successful device pickup
                        </div>
                        
                        <button class="btn btn-info btn-demo" onclick="confirmPickup()" id="confirmPickupBtn" disabled>
                            <i class="fas fa-check-circle me-2"></i>Confirm Device Pickup
                        </button>
                        
                        <div id="pickupResult" class="result-card bg-info bg-opacity-10 border-info"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Check -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="demo-card card">
                    <div class="card-body">
                        <h5 class="card-title text-secondary">
                            <i class="fas fa-search me-2"></i>Check Device Status
                        </h5>
                        <p class="card-text">
                            Check the current status of the device throughout the missing-to-found process.
                        </p>
                        
                        <button class="btn btn-secondary btn-demo" onclick="checkDeviceStatus()">
                            <i class="fas fa-info-circle me-2"></i>Check Status: IP14MISSING2025
                        </button>
                        
                        <div id="statusResult" class="result-card bg-secondary bg-opacity-10 border-secondary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000/api';
        let foundReportId = null;

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="foundDate"]').value = today;
        });

        async function reportMissingDevice() {
            try {
                const response = await fetch(`${API_BASE}/reports`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serialNumber: 'IP14MISSING2025',
                        ownerContact: 'john.doe@email.com',
                        reportType: 'missing',
                        incidentDate: new Date().toISOString(),
                        location: 'TechCorp Seminar Hall',
                        description: 'Lost my iPhone during the morning tech seminar. Might have dropped it while moving between sessions. Device has a blue protective case and contains important work data.'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('missingResult').innerHTML = `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-check-circle me-2"></i>Missing Device Report Filed</h6>
                            <p><strong>Report Number:</strong> ${result.data.report.reportNumber}</p>
                            <p><strong>Device:</strong> ${result.data.device ? result.data.device.brand + ' ' + result.data.device.model : 'Unregistered Device'}</p>
                            <p><strong>Status:</strong> <span class="status-badge bg-warning text-dark">Missing</span></p>
                            <p><strong>Next:</strong> Report found device to proceed with recovery.</p>
                        </div>
                    `;
                    document.getElementById('missingResult').style.display = 'block';
                } else {
                    throw new Error(result.error || 'Failed to file missing report');
                }
            } catch (error) {
                document.getElementById('missingResult').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
                document.getElementById('missingResult').style.display = 'block';
            }
        }

        async function reportFoundDevice() {
            document.getElementById('finderForm').style.display = 'block';
            document.getElementById('finderForm').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('foundDeviceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/reports/found-device`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    foundReportId = result.data.foundReport.id;
                    document.getElementById('foundResult').innerHTML = `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>Found Device Report Created</h6>
                            <p><strong>Found Report:</strong> ${result.data.foundReport.reportNumber}</p>
                            <p><strong>Status:</strong> <span class="status-badge bg-primary text-white">Pending Pickup</span></p>
                            <p><strong>Pickup Location:</strong> ${result.data.foundReport.pickupLocation}</p>
                            ${result.data.linkedToMissingReport ? 
                                `<p><strong>✓ Linked to Missing Report:</strong> Owner will be notified!</p>` : 
                                `<p><strong>Note:</strong> No matching missing report found.</p>`
                            }
                        </div>
                    `;
                    document.getElementById('foundResult').style.display = 'block';
                    document.getElementById('confirmPickupBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'Failed to create found device report');
                }
            } catch (error) {
                document.getElementById('foundResult').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
                document.getElementById('foundResult').style.display = 'block';
            }
        });

        async function confirmPickup() {
            if (!foundReportId) {
                alert('Please report a found device first');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/reports/found/${foundReportId}/confirm-pickup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        confirmedBy: 'Security Admin - Mike Rodriguez',
                        confirmationNotes: 'Owner provided photo ID and device passcode for verification. Device successfully returned.'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('pickupResult').innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-check-circle me-2"></i>Pickup Confirmed Successfully</h6>
                            <p><strong>Status:</strong> <span class="status-badge bg-success text-white">Completed</span></p>
                            <p><strong>Confirmed by:</strong> ${result.data.foundReport.confirmedBy}</p>
                            <p><strong>Pickup Time:</strong> ${new Date(result.data.foundReport.pickedUpAt).toLocaleString()}</p>
                            ${result.data.linkedMissingReportUpdated ? 
                                `<p><strong>✓ Missing report automatically resolved!</strong></p>` : ''
                            }
                        </div>
                    `;
                    document.getElementById('pickupResult').style.display = 'block';
                } else {
                    throw new Error(result.error || 'Failed to confirm pickup');
                }
            } catch (error) {
                document.getElementById('pickupResult').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
                document.getElementById('pickupResult').style.display = 'block';
            }
        }

        async function checkDeviceStatus() {
            try {
                const response = await fetch(`${API_BASE}/devices/serial/IP14MISSING2025`);
                const result = await response.json();
                
                if (result.success) {
                    const device = result.data.device;
                    const statusColors = {
                        'safe': 'success',
                        'stolen': 'danger',
                        'lost': 'warning',
                        'missing': 'info',
                        'found': 'primary'
                    };
                    
                    document.getElementById('statusResult').innerHTML = `
                        <div class="alert alert-secondary">
                            <h6><i class="fas fa-info-circle me-2"></i>Device Status Check</h6>
                            <p><strong>Device:</strong> ${device.brand} ${device.model}</p>
                            <p><strong>Serial:</strong> ${device.serialNumber}</p>
                            <p><strong>Status:</strong> <span class="status-badge bg-${statusColors[device.status.status] || 'secondary'} text-white">${device.status.status.toUpperCase()}</span></p>
                            <p><strong>Message:</strong> ${device.status.message}</p>
                            ${device.status.reportDate ? `<p><strong>Report Date:</strong> ${new Date(device.status.reportDate).toLocaleDateString()}</p>` : ''}
                            ${device.status.location ? `<p><strong>Location:</strong> ${device.status.location}</p>` : ''}
                        </div>
                    `;
                    document.getElementById('statusResult').style.display = 'block';
                } else {
                    throw new Error(result.error || 'Device not found');
                }
            } catch (error) {
                document.getElementById('statusResult').innerHTML = `
                    <div class="alert alert-danger">Error: ${error.message}</div>
                `;
                document.getElementById('statusResult').style.display = 'block';
            }
        }
    </script>
</body>
</html>